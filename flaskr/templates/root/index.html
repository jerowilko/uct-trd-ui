{% extends 'base.html' %}

{% block head %}
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script type="text/javascript" charset="utf-8">
    var socket = io();
    socket.on('connect', function() {
        console.log('connect event');
    });
</script>
{% endblock %}

{% block header %}
  <h1>{% block title %}Home{% endblock %}</h1>
{% endblock %}

{% block content %}
  {% raw %}
  <div id="app">
      <h3>Services</h3>
      <div v-for="(value, name) in services">{{ name }}: {{ value}}</div>
      <h3>Actions</h3>
      <div v-for="action in actions" v-bind:key="action.id">
          <button @click="submit_action(action)">{{ action.text }}</button>
      </div>
      <h3>Action Output</h3>
      <div>
          <textarea>{{ action_output }}</textarea>
      </div>
  </div>
  {% endraw %}
  <script>
    var app = new Vue({
        el: '#app',
        data: {
            services: {},
            available_actions: [],
            action_output: null
        },
        computed: {
            actions() {
                result = []
                for (const action of this.available_actions) {
                    result.push({
                        id: action,
                        text: action
                    })
                }

                return result
            }
        },
        methods: {
            submit_action: function(action) {
                //console.log(action)
                app["action_output"] = `Running action: ${action.id}`
                socket.emit('run-action', action.id)
            }
        }
    })    

    socket.on('state', function (data) {
      for (var key in data) 
        app[key] = data[key]
        
      app["action_output"] = null
    })

    socket.on('cmd-output', function (data) {
      app["action_output"] = data.stdout
    })
  </script>
{% endblock %}